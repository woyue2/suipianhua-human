# 多套提示词系统 - 实施任务

## 任务概览

```
状态: 待开始
优先级: P1
预估工作量: 5人天
依赖: 无
```

## 任务清单

### Phase 1: 基础架构 (2人天)

#### T1.1 创建提示词类型定义
- **ID**: T1.1
- **优先级**: P0
- **状态**: [ ]
- **描述**: 创建完整的 TypeScript 类型定义
- **验收标准**:
  - [ ] `SystemPromptTemplate` 接口定义完成
  - [ ] `PromptConfig` 持久化结构定义完成
  - [ ] `PromptValidationResult` 验证结果类型完成
  - [ ] 类型导出到 `lib/prompts/types.ts`
- **涉及文件**:
  - `lib/prompts/types.ts` (新建)

#### T1.2 创建内置提示词集
- **ID**: T1.2
- **优先级**: P0
- **状态**: [ ]
- **描述**: 实现内置的提示词模板
- **验收标准**:
  - [ ] 默认提示词（智能重组、简单整理、详细整理）
  - [ ] 场景提示词（学术风格、会议纪要、项目管理、学习笔记）
  - [ ] 导出到 `lib/prompts/defaults/index.ts`
  - [ ] 导出到 `lib/prompts/templates/index.ts`
- **涉及文件**:
  - `lib/prompts/defaults/reorganize.ts` (新建)
  - `lib/prompts/defaults/index.ts` (新建)
  - `lib/prompts/templates/academic.ts` (新建)
  - `lib/prompts/templates/meeting.ts` (新建)
  - `lib/prompts/templates/project.ts` (新建)
  - `lib/prompts/templates/index.ts` (新建)

#### T1.3 创建提示词管理器
- **ID**: T1.3
- **优先级**: P0
- **状态**: [ ]
- **描述**: 实现核心的 PromptManager 类
- **验收标准**:
  - [ ] `getPrompt(id)` 获取提示词
  - [ ] `getAllPrompts()` 获取全部提示词
  - [ ] `addCustomPrompt()` 添加自定义提示词
  - [ ] `updateCustomPrompt()` 更新自定义提示词
  - [ ] `deleteCustomPrompt()` 删除自定义提示词
  - [ ] `validatePrompt()` 验证提示词有效性
  - [ ] `renderTemplate()` 模板变量替换
  - [ ] 本地存储持久化
- **涉及文件**:
  - `lib/prompts/manager.ts` (新建)
  - `lib/prompts/index.ts` (新建)

#### T1.4 添加类型导出
- **ID**: T1.4
- **优先级**: P0
- **状态**: [ ]
- **描述**: 更新类型定义文件
- **验收标准**:
  - [ ] 在 `types/index.ts` 中添加 `PromptConfig` 类型
  - [ ] 确保类型可被前端正确导入
- **涉及文件**:
  - `types/index.ts` (修改)

---

### Phase 2: API 层 (1人天)

#### T2.1 创建提示词 API 路由
- **ID**: T2.1
- **优先级**: P0
- **状态**: [ ]
- **描述**: 创建提示词 CRUD API
- **验收标准**:
  - [ ] `GET /api/ai/prompt` 返回所有提示词
  - [ ] `POST /api/ai/prompt` 创建自定义提示词
  - [ ] `PATCH /api/ai/prompt` 更新自定义提示词
  - [ ] `DELETE /api/ai/prompt` 删除自定义提示词
  - [ ] 输入验证和错误处理
- **涉及文件**:
  - `app/api/ai/prompt/route.ts` (新建)
  - `app/api/ai/prompt/validate.ts` (新建)

#### T2.2 修改 AI 重组 API
- **ID**: T2.2
- **优先级**: P0
- **状态**: [ ]
- **描述**: 扩展现有 API 支持提示词选择
- **验收标准**:
  - [ ] 支持 `promptId` 参数
  - [ ] 支持 `customPrompt` 参数
  - [ ] 支持 `customSystemPrompt` 参数
  - [ ] 正确读取提示词模板
  - [ ] 提示词选择优先级正确
- **涉及文件**:
  - `app/api/ai/reorganize/route.ts` (修改)

#### T2.3 创建提示词 Server Actions
- **ID**: T2.3
- **优先级**: P1
- **状态**: [ ]
- **描述**: 创建前端可用的 Server Actions
- **验收标准**:
  - [ ] `getPrompts()` 获取提示词列表
  - [ ] `saveCustomPrompt()` 保存自定义提示词
  - [ ] `deleteCustomPrompt()` 删除自定义提示词
  - [ ] `validateCustomPrompt()` 验证提示词
- **涉及文件**:
  - `app/actions/prompts.ts` (新建)

---

### Phase 3: 前端组件 (1.5人天)

#### T3.1 创建提示词选择器组件
- **ID**: T3.1
- **优先级**: P0
- **状态**: [ ]
- **描述**: 创建提示词选择 UI
- **验收标准**:
  - [ ] 显示内置提示词列表
  - [ ] 显示自定义提示词列表
  - [ ] 按分类筛选
  - [ ] 选中状态显示
  - [ ] 预览功能
- **涉及文件**:
  - `components/settings/PromptSelector.tsx` (新建)

#### T3.2 创建自定义提示词编辑器
- **ID**: T3.2
- **优先级**: P0
- **状态**: [ ]
- **描述**: 创建提示词编辑表单
- **验收标准**:
  - [ ] 名称输入
  - [ ] 描述输入
  - [ ] 系统提示词编辑器（多行）
  - [ ] Temperature 滑块
  - [ ] 输出格式选择
  - [ ] 表单验证
  - [ ] 保存/取消按钮
- **涉及文件**:
  - `components/settings/PromptEditor.tsx` (新建)

#### T3.3 创建提示词预览组件
- **ID**: T3.3
- **优先级**: P1
- **状态**: [ ]
- **描述**: 创建提示词内容预览
- **验收标准**:
  - [ ] 显示完整提示词内容
  - [ ] 高亮格式化
  - [ ] 变量说明
- **涉及文件**:
  - `components/settings/PromptPreview.tsx` (新建)

#### T3.4 创建提示词设置面板
- **ID**: T3.4
- **优先级**: P1
- **状态**: [ ]
- **描述**: 整合所有组件的设置页面
- **验收标准**:
  - [ ] 提示词选择器集成
  - [ ] 新建自定义提示词入口
  - [ ] 编辑/删除自定义提示词
  - [ ] 导入/导出功能
- **涉及文件**:
  - `components/settings/PromptSettings.tsx` (新建)

#### T3.5 创建提示词 Hook
- **ID**: T3.5
- **优先级**: P1
- **状态**: [ ]
- **描述**: 创建状态管理 Hook
- **验收标准**:
  - [ ] 提示词列表状态
  - [ ] 当前选中提示词
  - [ ] 本地存储同步
- **涉及文件**:
  - `hooks/usePromptConfig.ts` (新建)

---

### Phase 4: 集成与测试 (0.5人天)

#### T4.1 集成到现有设置页面
- **ID**: T4.1
- **优先级**: P0
- **状态**: [ ]
- **描述**: 将提示词设置集成到应用
- **验收标准**:
  - [ ] 在设置弹窗中添加 AI 提示词选项卡
  - [ ] 调整现有 UI 布局
  - [ ] 样式一致性
- **涉及文件**:
  - `components/editor/Header.tsx` (可能修改)
  - `components/settings/` (新建)

#### T4.2 数据迁移
- **ID**: T4.2
- **优先级**: P0
- **状态**: [ ]
- **描述**: 处理旧数据兼容
- **验收标准**:
  - [ ] 检测并迁移本地存储中的旧配置
  - [ ] 平滑过渡，不丢失用户数据
- **涉及文件**:
  - `lib/prompts/manager.ts` (修改)

#### T4.3 单元测试
- **ID**: T4.3
- **优先级**: P2
- **状态**: [ ]
- **描述**: 编写核心逻辑测试
- **验收标准**:
  - [ ] PromptManager 单元测试
  - [ ] 提示词验证逻辑测试
  - [ ] API 路由测试
- **涉及文件**:
  - `__tests__/prompts/` (新建)

---

## 任务依赖关系

```
T1.1 ─┬─> T1.2 ─> T1.3 ─> T1.4
      │
      └─> T2.1 ─> T2.2 ─> T2.3
                  │
                  └─> T3.1 ─> T3.2 ─> T3.3 ─> T3.4
                               │
                               └─> T3.5

T4.1 ─> [所有 Phase 1-3 完成]
T4.2 ─> T4.1
T4.3 ─> T4.1
```

## 验收流程

### 手动测试用例

```
┌─────────────────────────────────────────────────────────────┐
│ 测试用例清单                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC1: 提示词选择                                              │
│   前提: 用户已登录                                           │
│   步骤:                                                     │
│     1. 打开设置页面                                           │
│     2. 点击 "AI 提示词" 选项卡                               │
│     3. 选择 "学术风格"                                       │
│   预期:                                                     │
│     - 显示学术风格提示词列表                                 │
│     - 选中状态正确显示                                       │
│     - 预览功能可用                                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC2: 创建自定义提示词                                         │
│   步骤:                                                     │
│     1. 点击 "新建自定义"                                     │
│     2. 填写名称、描述、系统提示词                           │
│     3. 设置 Temperature                                     │
│     4. 点击保存                                             │
│   预期:                                                     │
│     - 自定义提示词出现在列表中                               │
│     - 可以被选中和使用                                       │
│     - 数据持久化到本地存储                                   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC3: 编辑自定义提示词                                        │
│   步骤:                                                     │
│     1. 点击自定义提示词的编辑按钮                             │
│     2. 修改内容                                              │
│     3. 保存                                                 │
│   预期:                                                     │
│     - 提示词更新成功                                         │
│     - 重新选中时使用新内容                                   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC4: 删除自定义提示词                                        │
│   步骤:                                                     │
│     1. 点击删除按钮                                          │
│     2. 确认删除                                             │
│   预期:                                                     │
│     - 提示词从列表移除                                       │
│     - 如是当前选中，自动切换到默认                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC5: 使用自定义提示词进行 AI 重组                            │
│   步骤:                                                     │
│     1. 选中自定义提示词                                      │
│     2. 点击 AI 重组按钮                                      │
│   预期:                                                     │
│     - API 正确传递自定义提示词                               │
│     - AI 输出符合自定义提示词的要求                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ UC6: 导入/导出提示词配置                                     │
│   步骤:                                                     │
│     1. 点击导出按钮                                          │
│     2. 下载 JSON 文件                                       │
│     3. 清空本地数据                                         │
│     4. 点击导入按钮                                          │
│     5. 选择 JSON 文件                                       │
│   预期:                                                     │
│     - 导出文件包含正确的 JSON 结构                           │
│     - 导入后数据完整恢复                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 风险与对策

| 风险 | 概率 | 影响 | 对策 |
|------|------|------|------|
| 提示词格式错误导致 API 报错 | 中 | 低 | 前端表单验证 + 后端双重验证 |
| 本地存储空间不足 | 低 | 低 | 限制自定义提示词数量和长度 |
| 跨域问题（未来多设备同步） | 低 | 中 | 设计时考虑 API 接口可扩展性 |
| 提示词注入攻击 | 低 | 高 | 敏感内容过滤 + 服务器端验证 |

## 里程碑

| 里程碑 | 预计时间 | 交付物 |
|--------|----------|--------|
| M1: 基础架构完成 | 第1天 | 类型定义 + 提示词管理器 |
| M2: API 层完成 | 第2天 | 完整 API + Server Actions |
| M3: 前端组件完成 | 第3.5天 | 完整 UI 组件 |
| M4: 集成测试完成 | 第4天 | 可用的提示词系统 |
| M5: 优化与完善 | 第5天 | 文档 + 测试 |

## 资源需求

- **前端开发**: 2.5人天
- **后端开发**: 1人天
- **测试**: 0.5人天
- **Code Review**: 0.5人天
- **文档**: 0.5人天

---

## 执行命令

如需执行此方案，请输入：

```
~exec
```
