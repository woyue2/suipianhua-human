# å¤§çº²ç¼–è¾‘å™¨ - è®¾è®¡è§„æ ¼è‰æ¡ˆ

> åŸºäº Next.js çš„ AI æ™ºèƒ½å¤§çº²æ•´ç†å·¥å…·

## é¡¹ç›®æ¦‚è¿°

ä¸€ä¸ªç±»ä¼¼å¹•å¸ƒçš„å¤§çº²ç¬”è®°åº”ç”¨ï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯**AI æ™ºèƒ½é‡ç»„** - åˆ†æç”¨æˆ·çš„å¤§çº²å†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«ä¸»é¢˜å¹¶å»ºç«‹å±‚çº§åˆ†ç±»å…³ç³»ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… è‡ªç”±ç¼–è¾‘çš„å¤§çº²ç¬”è®°ï¼ˆç±»ä¼¼å¹•å¸ƒä½“éªŒï¼‰
- âœ… æ— é™å±‚çº§æ”¯æŒï¼ŒæŠ˜å /å±•å¼€
- âœ… å›¾ç‰‡æ’å…¥ï¼ˆæ”¯æŒç¬¬ä¸‰æ–¹å›¾åºŠï¼‰
- âœ… AI æ™ºèƒ½é‡ç»„å¤§çº²ç»“æ„ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… JSON æ ¼å¼å¯¼å…¥/å¯¼å‡º
- âœ… æç®€ UI è®¾è®¡ï¼ˆç±»ä¼¼å¹•å¸ƒï¼‰

### æ¬¡è¦åŠŸèƒ½ï¼ˆå¯åç»­è¿­ä»£ï¼‰
- æœç´¢åŠŸèƒ½
- å¿«æ·é”®æ”¯æŒ
- æ’¤é”€/é‡åš

### æ–‡ä»¶å¤¹åŠŸèƒ½ï¼ˆåç»­è¿­ä»£ï¼‰
**MVP é˜¶æ®µä¸å®ç°æ–‡ä»¶å¤¹åŠŸèƒ½ï¼ŒåŸå› ï¼š**

1. **æ ¸å¿ƒç›®æ ‡èšç„¦**
   - MVP çš„æ ¸å¿ƒæ˜¯éªŒè¯æ ¸å¿ƒåŠŸèƒ½é—­ç¯ï¼šç¼–è¾‘ã€AI é‡ç»„ã€ä¿å­˜ã€å¯¼å…¥å¯¼å‡º
   - æ–‡ä»¶å¤¹å±äºæ–‡æ¡£ç»„ç»‡ç®¡ç†çš„æ¬¡è¦åŠŸèƒ½ï¼Œä¸å½±å“æ ¸å¿ƒä½“éªŒéªŒè¯

2. **ç®€åŒ–å®ç°**
   - MVP é˜¶æ®µä½¿ç”¨**å¹³é“ºçš„æ–‡æ¡£åˆ—è¡¨**ï¼ˆæ‰€æœ‰æ–‡æ¡£å±•ç¤ºåœ¨åŒä¸€åˆ—è¡¨ä¸­ï¼‰
   - é€šè¿‡æ ‡é¢˜æˆ–åˆ›å»ºæ—¶é—´æ’åºï¼Œæ»¡è¶³åŸºæœ¬æ–‡æ¡£ç®¡ç†éœ€æ±‚
   - å‡å°‘æ•°æ®æ¨¡å‹å¤æ‚åº¦ï¼ˆæ— éœ€ Folder å®ä½“ã€åµŒå¥—å…³ç³»ã€folderId å­—æ®µï¼‰

3. **åç»­è¿­ä»£æ–¹å‘**
   - V2+ å¯æ‰©å±•æ–‡ä»¶å¤¹åŠŸèƒ½ï¼š
     - æ–°å¢ Folder å®ä½“ï¼ˆidã€nameã€childrenï¼‰
     - æ”¯æŒæ–‡ä»¶å¤¹å±•å¼€/æŠ˜å  UI
     - æ”¯æŒæ‹–æ‹½æ’åºå’Œå³é”®èœå•
   - å½“å‰æ¶æ„å·²é¢„ç•™æ‰©å±•æ€§ï¼ˆé€šè¿‡ API + Zustand æ¨¡å¼ï¼‰

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **Next.js 14+** (App Router) - å…¨æ ˆæ¡†æ¶
- **TypeScript** - ç±»å‹å®‰å…¨
- **Tailwind CSS** - æ ·å¼
- **shadcn/ui** - UI ç»„ä»¶åº“

### çŠ¶æ€ç®¡ç†
- **Zustand** - å…¨å±€çŠ¶æ€ç®¡ç†
- **Zustand Immer ä¸­é—´ä»¶** - å¤„ç†æ·±åº¦åµŒå¥—æ•°æ®

### æ•°æ®å­˜å‚¨
- **IndexedDB (Dexie.js)** - æœ¬åœ°æ•°æ®æŒä¹…åŒ–
- **JSON æ–‡ä»¶** - å¯¼å…¥/å¯¼å‡º

### AI é›†æˆ
- **Vercel AI SDK** - ç»Ÿä¸€ AI æ¥å£
- **Zod** - AI è¾“å‡ºç±»å‹éªŒè¯
- **æ”¯æŒå¤šæä¾›å•†**: Claude | OpenAI | Gemini

### å›¾åºŠä¸Šä¼ 
- **ç”¨æˆ·é…ç½®ç¬¬ä¸‰æ–¹å›¾åºŠ** (Imgur | SM.MS | è‡ªå®šä¹‰)
- **Next.js Route Handlers** - ä¸Šä¼ ä»£ç†

---

## æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“

```typescript
// === æ ¸å¿ƒä¸šåŠ¡å®ä½“ ===

// å®šä¹‰æ‰å¹³åŒ–çš„èŠ‚ç‚¹ï¼ˆç”¨äº Store å­˜å‚¨å±‚ï¼‰
// children å­˜å‚¨ ID æ•°ç»„ï¼Œå®ç°çœŸæ­£çš„æ‰å¹³åŒ–
interface StoredOutlineNode {
  id: string;
  parentId: string | null;
  content: string;
  level: number;
  children: string[];          // [å…³é”®ä¿®æ­£] å­˜å‚¨ ID æ•°ç»„ï¼Œè€Œéå¯¹è±¡æ•°ç»„
  images: ImageAttachment[];
  collapsed: boolean;
  createdAt: number;
  updatedAt: number;
}

// å®šä¹‰æ ‘å½¢èŠ‚ç‚¹ï¼ˆç”¨äº UI æ¸²æŸ“å’Œå¯¼å‡ºï¼‰
// children æ˜¯å¯¹è±¡æ•°ç»„ï¼Œæ–¹ä¾¿ç»„ä»¶ç›´æ¥ä½¿ç”¨
interface OutlineNode {
  id: string;
  parentId: string | null;
  content: string;
  level: number;
  children: OutlineNode[];     // æ¸²æŸ“æ—¶ä½¿ç”¨å¯¹è±¡æ•°ç»„
  images: ImageAttachment[];
  collapsed: boolean;
  createdAt: number;
  updatedAt: number;
}

interface ImageAttachment {
  id: string;
  url: string;
  thumbnail?: string;
  width: number;
  height: number;
  alt?: string;                 // [æ–°å¢] è¯­ä¹‰åŒ–ä¿¡æ¯
  caption?: string;             // [æ–°å¢] å›¾ç‰‡è¯´æ˜
  uploadedAt: number;
}

interface Document {
  id: string;
  title: string;
  root: OutlineNode;
  metadata: {
    createdAt: number;
    updatedAt: number;
    version: string;
  };
}

// === AI åŠŸèƒ½å®ä½“ ===

interface ReorganizePlan {
  originalStructure: OutlineNode;
  proposedStructure: OutlineNode;
  changes: ReorganizeChange[];
  reasoning: string;
}

interface ReorganizeChange {
  type: 'move' | 'rename' | 'merge' | 'split' | 'create_category';
  description: string;
  fromPath: string[];           // [ä¿®æ­£] ID è·¯å¾„
  toPath: string[];             // [ä¿®æ­£] ID è·¯å¾„
}

// === é…ç½®å®ä½“ ===

interface UserConfig {
  aiProvider: 'claude' | 'openai' | 'gemini';
  apiKeys: {
    claude?: string;
    openai?: string;
    gemini?: string;
  };
  imageUpload: {
    provider: 'imgur' | 'smms' | 'custom';
    customUrl?: string;
    apiKey?: string;
  };
}
```

---

## æ•´ä½“æ¶æ„

### å‰åç«¯ä¸€ä½“åŒ–æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js å…¨æ ˆåº”ç”¨                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   å‰ç«¯ (å®¢æˆ·ç«¯)   â”‚         â”‚   åç«¯ (æœåŠ¡ç«¯)   â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ â€¢ React ç»„ä»¶      â”‚         â”‚ â€¢ API Routes     â”‚          â”‚
â”‚  â”‚ â€¢ Zustand Store   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â€¢ Server Actionsâ”‚          â”‚
â”‚  â”‚ â€¢ äº¤äº’é€»è¾‘        â”‚         â”‚ â€¢ AI è°ƒç”¨        â”‚          â”‚
â”‚  â”‚ â€¢ IndexedDB       â”‚         â”‚ â€¢ å›¾åºŠä¸Šä¼ ä»£ç†    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æµ:
  ç”¨æˆ·æ“ä½œ â†’ Zustand Store â†’ æ›´æ–°å†…å­˜çŠ¶æ€
                           â†“
                     åŒæ­¥åˆ° IndexedDB

  AI é‡ç»„ â†’ å‰ç«¯è§¦å‘ â†’ Server Action â†’ AI API
                           â†“
                     è¿”å›é‡ç»„è®¡åˆ’ â†’ å‰ç«¯ç¡®è®¤ â†’ åº”ç”¨å˜æ›´

  å›¾åºŠä¸Šä¼  â†’ å‰ç«¯é€‰æ‹© â†’ Route Handler â†’ å›¾åºŠ API
                           â†“
                     è¿”å›å›¾ç‰‡ URL â†’ æ’å…¥å¤§çº²
```

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ app/                          # Next.js App Router (è·¯ç”±å±‚)
â”‚   â”œâ”€â”€ api/                      # API è·¯ç”± (åç«¯ä»£ç†)
â”‚   â”‚   â”œâ”€â”€ ai/                   # AI æµå¼è½¬å‘ç­‰
â”‚   â”‚   â”‚   â””â”€â”€ reorganize/       # AI é‡ç»„æ¥å£
â”‚   â”‚   â””â”€â”€ upload/               # å›¾ç‰‡ä¸Šä¼ ä»£ç†
â”‚   â”œâ”€â”€ actions/                  # Server Actions (é€»è¾‘å±‚)
â”‚   â”‚   â””â”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰æœåŠ¡ç«¯æ“ä½œ
â”‚   â”œâ”€â”€ layout.tsx                # å…¨å±€å¸ƒå±€
â”‚   â””â”€â”€ page.tsx                  # å…¥å£é¡µé¢
â”‚
â”œâ”€â”€ components/                   # React ç»„ä»¶ (å±•ç¤ºå±‚)
â”‚   â”œâ”€â”€ editor/                   # æ ¸å¿ƒä¸šåŠ¡ï¼šå¤§çº²ç¼–è¾‘å™¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Editor.tsx            # ä¸»ç¼–è¾‘å™¨å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ OutlineTree.tsx       # å¤§çº²æ ‘æ¸²æŸ“å™¨
â”‚   â”‚   â”œâ”€â”€ OutlineNode.tsx       # é€’å½’èŠ‚ç‚¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ NodeToggle.tsx        # æŠ˜å /å±•å¼€ç®­å¤´
â”‚   â”‚   â”œâ”€â”€ NodeContent.tsx       # å¯ç¼–è¾‘å†…å®¹
â”‚   â”‚   â”œâ”€â”€ NodeImages.tsx        # å›¾ç‰‡é™„ä»¶
â”‚   â”‚   â””â”€â”€ ImageUploader.tsx     # å›¾ç‰‡ä¸Šä¼ å™¨
â”‚   â”œâ”€â”€ ai/                       # æ ¸å¿ƒä¸šåŠ¡ï¼šAI äº¤äº’é¢æ¿
â”‚   â”‚   â”œâ”€â”€ AIReorganizeModal.tsx # AI é‡ç»„å¼¹çª—
â”‚   â”‚   â”œâ”€â”€ PlanPreview.tsx       # é‡ç»„è®¡åˆ’å±•ç¤º
â”‚   â”‚   â””â”€â”€ ConfirmButtons.tsx    # ç¡®è®¤/å–æ¶ˆæŒ‰é’®
â”‚   â”œâ”€â”€ ui/                       # åŸºç¡€ UI (shadcn/ui)
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ modal.tsx
â”‚   â”‚   â”œâ”€â”€ toast.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ Toolbar.tsx               # å·¥å…·æ 
â”‚
â”œâ”€â”€ lib/                          # ç¬¬ä¸‰æ–¹åº“å°è£… & æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ db.ts                     # IndexedDB å°è£… (Dexie.js)
â”‚   â”œâ”€â”€ store.ts                  # Zustand çŠ¶æ€å®šä¹‰
â”‚   â”œâ”€â”€ ai.ts                     # AI SDK è°ƒç”¨é€»è¾‘
â”‚   â”œâ”€â”€ ai-schema.ts              # Zod Schema å®šä¹‰
â”‚   â””â”€â”€ image.ts                  # å›¾åºŠ SDK å°è£…
â”‚
â”œâ”€â”€ types/                        # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts                  # ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰ç±»å‹
â”‚
â””â”€â”€ utils/                        # çº¯å·¥å…·å‡½æ•°
    â”œâ”€â”€ tree-diff.ts              # æ ‘å·®å¼‚è®¡ç®—ç®—æ³•
    â”œâ”€â”€ format.ts                 # æ ¼å¼åŒ–å·¥å…·
    â””â”€â”€ id.ts                     # ID ç”Ÿæˆï¼ˆä½¿ç”¨ crypto.randomUUID()ï¼‰
```

### UUID ç”Ÿæˆ

**ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ APIï¼ˆæ— éœ€é¢å¤–ä¾èµ–ï¼‰ï¼š**

```typescript
// utils/id.ts
/**
 * ç”Ÿæˆå”¯ä¸€çš„ ID
 * ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ crypto.randomUUID() (ç°ä»£æµè§ˆå™¨å’Œ Node.js 20+ éƒ½æ”¯æŒ)
 */
export const generateId = () => crypto.randomUUID();
```

---

## æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. å¤§çº²ç¼–è¾‘å™¨

#### 1.1 è¾“å…¥æ§ä»¶é€‰æ‹©
```typescript
// âœ… æ¨èï¼šä½¿ç”¨ input + CSS å»æ‰è¾¹æ¡†
<input
  type="text"
  value={content}
  className="border-none bg-transparent outline-none"
  onChange={(e) => updateNodeContent(id, e.target.value)}
/>

// âŒ ä¸æ¨èï¼šcontenteditableï¼ˆå…‰æ ‡ç®¡ç†æå…¶å¤æ‚ï¼‰
<div contentEditable={true}>{content}</div>
```

#### 1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**æ‰å¹³åŒ– Store å­˜å‚¨**
```typescript
// lib/store.ts
interface EditorStore {
  // æ‰å¹³åŒ–å­˜å‚¨ï¼šæ‰€æœ‰èŠ‚ç‚¹å¹³é“ºåœ¨å­—å…¸ä¸­
  nodes: Record<string, StoredOutlineNode>; // [ä¿®æ­£] ä½¿ç”¨å­˜å‚¨ç±»å‹
  rootId: string;
  documentId: string; // æ–‡æ¡£ ID
  title: string;

  // Actions - ç›´æ¥é€šè¿‡ ID æ“ä½œï¼ŒO(1) å¤æ‚åº¦
  updateNodeContent: (id: string, content: string) => void;
  toggleCollapse: (id: string) => void;
  addImage: (nodeId: string, image: ImageAttachment) => void;
  applyReorganizePlan: (plan: ReorganizePlan) => void;

  // è¾…åŠ©æ–¹æ³•
  buildDocumentTree: () => Document; // [æ–°å¢] ä»æ‰å¹³æ•°æ®æ„å»º Document å¯¹è±¡
  loadDocument: (document: Document) => void; // [æ–°å¢] åŠ è½½ Document åˆ°æ‰å¹³ Store
}

// ä½¿ç”¨ Immer + æ‰å¹³åŒ–å­˜å‚¨
export const useEditorStore = create<EditorStore>()(
  immer((set, get) => ({
    nodes: {},
    rootId: '',
    documentId: '',
    title: '',

    updateNodeContent: (id, content) => {
      set(state => {
        if (state.nodes[id]) {
          state.nodes[id].content = content;
        }
      });
    },

    // [æ–°å¢] ä»æ‰å¹³æ•°æ®æ„å»º Document å¯¹è±¡ï¼ˆç”¨äºä¿å­˜å’Œå¯¼å‡ºï¼‰
    buildDocumentTree: (): Document => {
      const state = get();
      const nodesMap = state.nodes;
      const rootNode = nodesMap[state.rootId];

      if (!rootNode) {
        throw new Error('Root node not found');
      }

      // é€’å½’æ„å»ºæ ‘
      const buildNode = (nodeId: string): OutlineNode => {
        const storedNode = nodesMap[nodeId];
        return {
          ...storedNode,
          // [å…³é”®] å°† children çš„ ID æ•°ç»„è½¬æ¢ä¸ºçœŸå®çš„èŠ‚ç‚¹å¯¹è±¡æ•°ç»„
          children: storedNode.children.map(buildNode),
        } as OutlineNode;
      };

      return {
        id: state.documentId,
        title: state.title,
        root: buildNode(state.rootId),
        metadata: {
          createdAt: rootNode.createdAt,
          updatedAt: rootNode.updatedAt,
          version: '1.0.0',
        },
      };
    },

    // [æ–°å¢] åŠ è½½ Document åˆ°æ‰å¹³ Storeï¼ˆç”¨äºå¯¼å…¥ï¼‰
    loadDocument: (document: Document) => {
      set(state => {
        state.documentId = document.id;
        state.title = document.title;
        state.rootId = document.root.id;

        const nodesMap: Record<string, StoredOutlineNode> = {};

        // é€’å½’æ‰å¹³åŒ–æ ‘
        const flattenNode = (node: OutlineNode, parentId: string | null = null) => {
          const childrenIds = node.children.map(child => child.id);

          nodesMap[node.id] = {
            ...node,
            parentId,
            // [å…³é”®] children å­˜å‚¨ ID æ•°ç»„
            children: childrenIds,
          } as StoredOutlineNode;

          // é€’å½’å¤„ç†å­èŠ‚ç‚¹
          node.children.forEach(child => flattenNode(child, node.id));
        };

        flattenNode(document.root, null);
        state.nodes = nodesMap;
      });
    },

    // ...å…¶ä»– actions
  }))
);
```

**React.memo ä¼˜åŒ–**
```typescript
// components/editor/OutlineNode.tsx
import { memo } from 'react';
import { useEditorStore } from '@/lib/store';

// ä½¿ç”¨ React.memo åŒ…è£¹ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
export const OutlineNode = memo(function OutlineNode({
  nodeId,
  depth
}: OutlineNodeProps) {
  // ä½¿ç”¨ Selector åªè®¢é˜…éœ€è¦çš„æ•°æ®
  const node = useEditorStore(state => state.nodes[nodeId]);
  const updateContent = useEditorStore(state => state.updateNodeContent);

  return (
    <div className="flex" style={{ marginLeft: depth * 24 }}>
      <NodeToggle nodeId={nodeId} />
      <input
        value={node.content}
        onChange={(e) => updateContent(nodeId, e.target.value)}
        className="border-none bg-transparent"
      />
      <NodeImages images={node.images} />
    </div>
  );
});
```

#### 1.3 æŠ˜å /å±•å¼€äº¤äº’
- ç‚¹å‡»ä¸“é—¨çš„ç®­å¤´å›¾æ ‡æ§åˆ¶ï¼ˆä¸å½±å“æ–‡æœ¬ç¼–è¾‘ï¼‰
- ä½¿ç”¨ç®­å¤´å›¾æ ‡ï¼šâ–¶ / â–¼
- æŠ˜å çŠ¶æ€ä¿å­˜åœ¨ `node.collapsed` å­—æ®µ

---

### 2. AI æ™ºèƒ½é‡ç»„ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

#### 2.1 åŠŸèƒ½å®šä½

**é‡ç‚¹åœ¨äºåˆ†ç±»å’Œå±‚çº§æ•´ç†**ï¼Œè€Œéç®€å•æ’åºï¼š
- è¯†åˆ«å†…å®¹ä¸»é¢˜
- åˆ›å»ºçˆ¶çº§åˆ†ç±»èŠ‚ç‚¹
- å°†ç›¸å…³å†…å®¹å½’ç±»
- å»ºç«‹åˆç†çš„å±‚çº§å…³ç³»

**ç¤ºä¾‹ï¼š**
```
åŸå§‹æ··ä¹±ç»“æ„ï¼š
å¦‚ä½•å­¦ä¹ ç¼–ç¨‹
Python åŸºç¡€
å˜é‡
æ•°æ®ç±»å‹
JavaScript
ES6 æ–°ç‰¹æ€§
ç®­å¤´å‡½æ•°

AI æ•´ç†åï¼š
ç¼–ç¨‹å­¦ä¹ 
â”œâ”€ Python
â”‚  â”œâ”€ å˜é‡
â”‚  â””â”€ æ•°æ®ç±»å‹
â””â”€ JavaScript
   â””â”€ ES6 æ–°ç‰¹æ€§
      â””â”€ ç®­å¤´å‡½æ•°
```

#### 2.2 å®ç°æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"AI æ•´ç†"
     â†“
1. æå–çº¯æ–‡æœ¬ç»“æ„ï¼ˆå»é™¤ IDã€æ—¶é—´æˆ³ç­‰ï¼‰
     â†“
2. è°ƒç”¨ generateObjectï¼ˆZod ä¿è¯ç±»å‹å®‰å…¨ï¼‰
     â†“
3. AI è¿”å› newStructureï¼ˆæ—  ID çš„æ ‘ï¼‰
     â†“
4. å‰ç«¯ç”Ÿæˆæ–°çš„ UUIDï¼Œæ„å»ºå®Œæ•´æ ‘
     â†“
5. å‰ç«¯ç®—æ³•è®¡ç®— Diffï¼ˆchanges åˆ—è¡¨ï¼‰
     â†“
6. å±•ç¤ºé¢„è§ˆ + ç¡®è®¤åº”ç”¨
```

#### 2.3 Zod Schema å®šä¹‰

```typescript
// lib/ai-schema.ts
import { z } from 'zod';

// å®šä¹‰ AI éœ€è¦è¿”å›çš„èŠ‚ç‚¹ç»“æ„ï¼ˆä¸éœ€è¦ IDï¼Œåªéœ€è¦å†…å®¹ï¼‰
export const AIOutlineNodeSchema = z.object({
  content: z.string(),
  children: z.array(z.lazy(() => AIOutlineNodeSchema)),
});

export const ReorganizeResultSchema = z.object({
  reasoning: z.string(),           // AI çš„æ•´ç†ç†ç”±
  newStructure: AIOutlineNodeSchema, // æ•´ç†åçš„å®Œæ•´æ ‘ç»“æ„ï¼ˆä¸å« IDï¼‰
});
```

#### 2.4 Server Action å®ç°

```typescript
// app/actions/ai.ts
'use server'
import { openai } from '@ai-sdk/openai';
import { generateObject } from 'ai';
import { ReorganizeResultSchema } from '@/lib/ai-schema';

export async function reorganizeOutline(currentTree: OutlineNode) {
  // æå–çº¯æ–‡æœ¬ç»“æ„å‘ç»™ AIï¼ˆå‡å°‘ Tokenï¼Œä¹Ÿé˜²æ­¢æ³„éœ² IDï¼‰
  const plainTextTree = extractContentFromTree(currentTree);

  const result = await generateObject({
    model: openai('gpt-4o-mini'),
    schema: ReorganizeResultSchema,
    prompt: `
ä½ æ˜¯ä¸€ä¸ªå¤§çº²æ•´ç†åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹æ··ä¹±çš„åˆ—è¡¨æ•´ç†æˆå±‚çº§æ¸…æ™°çš„æ ‘çŠ¶ç»“æ„ã€‚

è¦æ±‚ï¼š
1. è¯†åˆ«ä¸»é¢˜ï¼Œåˆ›å»ºçˆ¶çº§åˆ†ç±»
2. å°†ç›¸å…³å†…å®¹å½’çº³åˆ°åˆ†ç±»ä¸‹
3. åªè¿”å› JSON ç»“æ„ï¼Œä¸è¦åŒ…å« ID

åŸå§‹å†…å®¹ï¼š
${JSON.stringify(plainTextTree)}
    `,
  });

  return result.object; // ç›´æ¥æ‹¿åˆ°ç±»å‹å®‰å…¨çš„ { reasoning, newStructure }
}
```

#### 2.5 å‰ç«¯ Diff è®¡ç®—

**âš ï¸ ç®—æ³•å±€é™æ€§è¯´æ˜ï¼ˆMVP é˜¶æ®µå¯æ¥å—ï¼‰ï¼š**

å½“å‰ Diff ç®—æ³•åŸºäº"å†…å®¹æ–‡æœ¬"åŒ¹é…ï¼Œå­˜åœ¨ä»¥ä¸‹å±€é™æ€§ï¼š

1. **é‡åå†²çª**ï¼šå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹å†…å®¹ç›¸åŒï¼ˆå¦‚ä¸¤ä¸ª"ç¬¬ä¸€ç« "ï¼‰ï¼Œç®—æ³•å¯èƒ½æ··æ·†
2. **æ”¹åæ— æ³•è¯†åˆ«**ï¼šAI å°†"ä»‹ç»"æ”¹ä¸º"ç®€ä»‹"æ—¶ï¼Œä¼šè¢«åˆ¤å®šä¸º"åˆ é™¤æ—§èŠ‚ç‚¹ + æ–°å»ºèŠ‚ç‚¹"ï¼Œè€Œé"é‡å‘½å"
3. **è§£å†³æ–¹æ¡ˆ**ï¼š
   - åœ¨ Prompt ä¸­æ˜ç¡®è¦æ±‚ AI å°½é‡ä¿ç•™åŸå§‹æ–‡æœ¬ï¼Œé¿å…é‡å‘½å
   - åœ¨ UI çš„ PlanPreview ä¸­ï¼Œå¯¹äºåˆ¤å®šä¸º `create` çš„èŠ‚ç‚¹ï¼Œä¸è¦æ˜¾ç¤ºçº¢è‰²è­¦å‘Š
   - ç»™ç”¨æˆ·é€‚å½“çš„å¿ƒç†é¢„æœŸï¼ˆå¯èƒ½æ˜¯æ”¹åæˆ–åˆå¹¶æ“ä½œï¼‰

**æœªæ¥ä¼˜åŒ–æ–¹å‘**ï¼ˆV2+ï¼‰ï¼š
- ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦åŒ¹é…å†…å®¹ï¼Œè€Œéç²¾ç¡®å­—ç¬¦ä¸²åŒ¹é…
- AI åœ¨è¿”å›ç»“æœæ—¶åŒ…å«"åŸå§‹ ID æ˜ å°„"ï¼ˆéœ€è¦ä¿®æ”¹ Prompt è¾“å‡ºæ ¼å¼ï¼‰

```typescript
// utils/tree-diff.ts
import { OutlineNode, ReorganizeChange } from '@/types';

export function calculateDiff(
  oldTree: OutlineNode,
  newTree: OutlineNode
): ReorganizeChange[] {
  const changes: ReorganizeChange[] = [];

  // éå†æ–°æ ‘ï¼ŒæŸ¥æ‰¾æ¯ä¸ªèŠ‚ç‚¹çš„æ¥æº
  function traverse(newNode: OutlineNode, path: string[]) {
    const oldLocation = findNodeInTree(oldTree, newNode.content);

    if (oldLocation) {
      // èŠ‚ç‚¹å­˜åœ¨ä½†è·¯å¾„å˜äº† â†’ ç§»åŠ¨æ“ä½œ
      if (oldLocation.path.join('/') !== path.join('/')) {
        changes.push({
          type: 'move',
          description: `ä» "${oldLocation.path.join('/')}" ç§»åŠ¨åˆ°æ­¤`,
          fromPath: oldLocation.path,
          toPath: path,
        });
      }
    } else {
      // èŠ‚ç‚¹ä¸å­˜åœ¨ â†’ æ–°å»ºåˆ†ç±»ï¼ˆå¯èƒ½æ˜¯æ”¹åæˆ–åˆå¹¶ï¼‰
      changes.push({
        type: 'create_category',
        description: 'æ–°å»ºåˆ†ç±»',
        fromPath: [],
        toPath: path,
      });
    }

    newNode.children.forEach(child =>
      traverse(child, [...path, newNode.content])
    );
  }

  traverse(newTree, [newTree.content]);
  return changes;
}
```

#### 2.6 ç»„ä»¶å®ç°

```typescript
// components/ai/AIReorganizeModal.tsx
'use client'
import { useState } from 'react';
import { reorganizeOutline } from '@/app/actions';
import { calculateDiff } from '@/utils/tree-diff';
import { OutlineNode } from '@/types';

export function AIReorganizeModal({ document }: { document: Document }) {
  const [isLoading, setIsLoading] = useState(false);
  const [previewData, setPreviewData] = useState<{
    newTree: OutlineNode;
    changes: ReorganizeChange[];
  } | null>(null);

  const handleReorganize = async () => {
    setIsLoading(true);
    try {
      const aiResult = await reorganizeOutline(document.root);

      // 1. å°† AI è¿”å›çš„æ—  ID ç»“æ„è½¬åŒ–ä¸ºå¸¦ ID çš„ OutlineNode
      const newTreeWithIds = buildTreeWithIds(aiResult.newStructure);

      // 2. è®¡ç®—å·®å¼‚
      const changes = calculateDiff(document.root, newTreeWithIds);

      setPreviewData({ newTree: newTreeWithIds, changes });
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Modal>
      {isLoading && <div>AI æ­£åœ¨æ€è€ƒåˆ†ç±»ç­–ç•¥...</div>}
      {previewData && (
        <PlanPreview
          originalTree={document.root}
          newTree={previewData.newTree}
          changes={previewData.changes}
        />
      )}
      <button onClick={handleReorganize}>å¼€å§‹æ•´ç†</button>
    </Modal>
  );
}
```

#### 2.7 UI è®¾è®¡ï¼ˆå¹¶æ’è§†å›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI é‡ç»„é¢„è§ˆ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸå§‹ç»“æ„            â”‚  é‡ç»„åç»“æ„                     â”‚
â”‚  â”œâ”€ ç¬¬ä¸€ç«            â”‚  â”œâ”€ ç¬¬ä¸€ç«  âœ…                   â”‚
â”‚  â”‚  â””â”€ 1.1           â”‚  â”‚  â”œâ”€ 1.1 (ä» 1.2 ç§»åŠ¨) ğŸ”„    â”‚
â”‚  â”‚     â””â”€ å†…å®¹       â”‚  â”‚  â””â”€ 1.2 (é‡å‘½åä¸º å°èŠ‚) âœï¸ â”‚
â”‚  â”‚  â””â”€ 1.2           â”‚  â””â”€ ç¬¬äºŒç«                      â”‚
â”‚  â””â”€ ç¬¬äºŒç«            â”‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI è¯´æ˜ï¼šæ£€æµ‹åˆ° 1.1 å’Œ 1.2 é¡ºåºæœ‰è¯¯ï¼Œå·²è°ƒæ•´é€»è¾‘é¡ºåº  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            [å–æ¶ˆ]              [ç¡®è®¤åº”ç”¨]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. å›¾åºŠä¸Šä¼ åŠŸèƒ½

#### 3.1 å®Œæ•´çš„å›¾åºŠé…ç½®ç³»ç»Ÿ

**æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š**
- é€šè¿‡åç«¯ä»£ç†ç»Ÿä¸€ä¸Šä¼ å…¥å£ï¼Œå›¾åºŠåˆ‡æ¢å¯¹ç»„ä»¶é€æ˜
- é€‚é…ä¸åŒå›¾åºŠçš„è¡¨å•å­—æ®µåå’Œå“åº”ç»“æ„å·®å¼‚
- å®Œæ•´çš„æ–‡ä»¶æ ¡éªŒï¼ˆç±»å‹ã€å¤§å°é™åˆ¶ï¼‰
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ ¼å¼

**å›¾åºŠå…ƒä¿¡æ¯é…ç½®ï¼š**
```typescript
// lib/image-upload.ts
export type ImageProvider = 'imgur' | 'smms' | 'custom';

export interface ImageUploadConfig {
  provider: ImageProvider;
  apiKey: string;
  customUrl?: string;
}

// å›¾åºŠå…ƒä¿¡æ¯ï¼šä¸Šä¼ åœ°å€ã€è®¤è¯å¤´ã€è¡¨å•å­—æ®µåã€å“åº”è§£æå‡½æ•°
export const IMAGE_PROVIDERS: Record<
  ImageProvider,
  {
    name: string;
    uploadUrl: string | ((config: ImageUploadConfig) => string);
    headers: (config: ImageUploadConfig) => Record<string, string>;
    formFieldName: string;
    parseResponse: (data: unknown) => { url: string } | null;
  }
> = {
  imgur: {
    name: 'Imgur',
    uploadUrl: 'https://api.imgur.com/3/image',
    headers: (cfg) => ({ Authorization: `Client-ID ${cfg.apiKey}` }),
    formFieldName: 'image', // Imgur ä½¿ç”¨ 'image' è€Œé 'file'
    parseResponse: (data: unknown) => {
      const d = data as { data?: { link?: string } } | undefined;
      if (d?.data?.link) return { url: d.data.link };
      return null;
    },
  },
  smms: {
    name: 'SM.MS',
    uploadUrl: 'https://sm.ms/api/v2/upload',
    headers: (cfg) => ({ Authorization: cfg.apiKey }),
    formFieldName: 'smfile', // SM.MS ä½¿ç”¨ 'smfile'
    parseResponse: (data: unknown) => {
      const d = data as
        | { success?: boolean; data?: { url?: string } }
        | undefined;
      if (d?.success && d.data?.url) return { url: d.data.url };
      return null;
    },
  },
  custom: {
    name: 'è‡ªå®šä¹‰',
    uploadUrl: (cfg) => cfg.customUrl || '',
    headers: (cfg) => ({ 'X-API-Key': cfg.apiKey }),
    formFieldName: 'file', // å¸¸è§çº¦å®š
    parseResponse: (data: unknown) => {
      // å‡è®¾è‡ªå®šä¹‰å›¾åºŠç»Ÿä¸€å“åº”ä¸º { url: string }
      const d = data as { url?: string } | undefined;
      if (d?.url) return { url: d.url };
      return null;
    },
  },
};
```

#### 3.2 åç«¯ä»£ç†ä¸Šä¼ ï¼ˆå®Œæ•´å®ç°ï¼‰

**å…³é”®ä¼˜åŒ–ï¼š**
- æ–‡ä»¶ç±»å‹å’Œå¤§å°æ ¡éªŒ
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ ¼å¼
- é…ç½®ä»è¯·æ±‚ Header è·å–ï¼ˆé¿å…æœåŠ¡ç«¯è¯» localStorageï¼‰
- å®Œæ•´çš„æ—¥å¿—è®°å½•

```typescript
// app/api/upload/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { IMAGE_PROVIDERS, ImageUploadConfig, ImageProvider } from '@/lib/image-upload';

// ä» header è·å–é…ç½®ï¼ˆå‰ç«¯ä¼ é€’ï¼‰
function getConfigFromRequest(req: NextRequest): ImageUploadConfig {
  const provider = (req.headers.get('x-image-provider') || 'imgur') as ImageProvider;
  const apiKey = req.headers.get('x-image-api-key') || '';
  const customUrl = req.headers.get('x-image-custom-url') || undefined;
  return { provider, apiKey, customUrl };
}

// æ–‡ä»¶æ ¡éªŒ
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
const ALLOWED_TYPES = /^image\/(png|jpeg|jpg|gif|webp)$/;

function validateFile(file: File) {
  if (!ALLOWED_TYPES.test(file.type)) {
    throw new Error('Unsupported image type');
  }
  if (file.size > MAX_FILE_SIZE) {
    throw new Error('File size exceeds 5 MB limit');
  }
}

export async function POST(req: NextRequest) {
  try {
    const formData = await req.formData();
    const file = formData.get('file') as File | null;

    if (!file) {
      return NextResponse.json(
        { success: false, error: { code: 'NO_FILE', message: 'æœªé€‰æ‹©æ–‡ä»¶' } },
        { status: 400 }
      );
    }

    validateFile(file);

    const config = getConfigFromRequest(req);
    const providerInfo = IMAGE_PROVIDERS[config.provider];

    const uploadUrl =
      typeof providerInfo.uploadUrl === 'function'
        ? providerInfo.uploadUrl(config)
        : providerInfo.uploadUrl;

    // æ„é€ å‘ç»™ç¬¬ä¸‰æ–¹å›¾åºŠçš„ formData
    const upstreamFormData = new FormData();
    upstreamFormData.append(providerInfo.formFieldName, file);

    const upstreamRes = await fetch(uploadUrl, {
      method: 'POST',
      headers: providerInfo.headers(config),
      body: upstreamFormData,
    });

    if (!upstreamRes.ok) {
      const text = await upstreamRes.text().catch(() => '');
      console.error('[upload] upstream error', upstreamRes.status, text);
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'UPSTREAM_ERROR',
            message: `å›¾åºŠè¿”å›é”™è¯¯ï¼š${upstreamRes.status}`,
            details: text,
          },
        },
        { status: upstreamRes.status }
      );
    }

    const upstreamData = await upstreamRes.json();
    const parsed = providerInfo.parseResponse(upstreamData);

    if (!parsed?.url) {
      console.error('[upload] æ— æ³•è§£æå›¾ç‰‡ URL', upstreamData);
      return NextResponse.json(
        {
          success: false,
          error: {
            code: 'PARSE_ERROR',
            message: 'å›¾åºŠè¿”å›æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ',
            details: upstreamData,
          },
        },
        { status: 502 }
      );
    }

    return NextResponse.json({ success: true, url: parsed.url });
  } catch (err: any) {
    console.error('[upload] unexpected error', err);
    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'INTERNAL_ERROR',
          message: err?.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
        },
      },
      { status: 500 }
    );
  }
}
```

#### 3.3 å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```typescript
// components/ImageUploader.tsx
'use client';

import { useRef, useState } from 'react';

type ImageProvider = 'imgur' | 'smms' | 'custom';

export function ImageUploader({
  provider,
  apiKey,
  customUrl,
  onUploaded,
}: {
  provider: ImageProvider;
  apiKey: string;
  customUrl?: string;
  onUploaded: (url: string) => void;
}) {
  const inputRef = useRef<HTMLInputElement>(null);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setUploading(true);
    setError(null);

    const formData = new FormData();
    formData.append('file', file);

    const headers: Record<string, string> = {
      'x-image-provider': provider,
      'x-image-api-key': apiKey,
    };
    if (customUrl) headers['x-image-custom-url'] = customUrl;

    try {
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers,
        body: formData,
      });

      const result = await res.json();

      if (!res.ok || !result.success) {
        throw new Error(result.error?.message || 'ä¸Šä¼ å¤±è´¥');
      }

      onUploaded(result.url);
    } catch (err: any) {
      setError(err?.message || 'ä¸Šä¼ å¤±è´¥');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div>
      <input
        ref={inputRef}
        type="file"
        accept="image/*"
        disabled={uploading}
        onChange={handleFileChange}
      />
      {uploading && <span>ä¸Šä¼ ä¸­...</span>}
      {error && <span style={{ color: 'red' }}>{error}</span>}
    </div>
  );
}
```

#### 3.4 å›¾ç‰‡æ’å…¥äº¤äº’ï¼ˆç±»ä¼¼å¹•å¸ƒï¼‰

**æ’å…¥æ–¹å¼ï¼š**
1. èœå•æ ã€Œæ·»åŠ å›¾ç‰‡ã€æŒ‰é’®
2. å¿«æ·é”® `Alt + Enter`ï¼ˆMac: `Option + Enter`ï¼‰
3. ç›´æ¥æ‹–æ‹½å›¾ç‰‡åˆ°ç¼–è¾‘å™¨
4. å¤åˆ¶ç²˜è´´å›¾ç‰‡

**æ˜¾ç¤ºæ–¹å¼ï¼š**
- å›¾ç‰‡ç›´æ¥æ˜¾ç¤ºåœ¨å¤§çº²å†…å®¹ä¸­
- å¯æ‹–åŠ¨è°ƒæ•´å¤§å°ï¼ˆç­‰æ¯”ç¼©æ”¾ï¼‰
- æ”¯æŒç¼©ç•¥å›¾ + ç‚¹å‡»æ”¾å¤§é¢„è§ˆ

#### 3.5 è®¾ç½®ç•Œé¢

**é…ç½®æŒä¹…åŒ–ï¼š**
- é…ç½®ä¿å­˜åœ¨ localStorageï¼ˆå®¢æˆ·ç«¯ï¼‰
- è®¾ç½®ç•Œé¢åªç»´æŠ¤é…ç½®å¯¹è±¡ï¼ˆprovider / apiKey / customUrlï¼‰
- ä¸Šä¼ æ—¶ä»é…ç½®è¯»å–å¹¶ä¼ é€’ç»™ ImageUploader
- é¿å…åœ¨è®¾ç½®ç»„ä»¶é‡Œè€¦åˆä¸Šä¼ é€»è¾‘

---

## æ•°æ®æŒä¹…åŒ–è®¾è®¡

### 1. æ•°æ®åº“è®¾è®¡ï¼ˆIndexedDB + Dexie.jsï¼‰

**å…³é”®ä¿®æ­£ï¼š**
- configs è¡¨çš„ key æ˜¯ string ç±»å‹ä¸»é”®ï¼Œä¸è¦ç”¨ `++`
- ä½¿ç”¨æ³›å‹æŒ‡å®šä¸»é”®ç±»å‹ï¼š`Table<ConfigDocument, string>`

```typescript
// lib/db.ts
import Dexie, { Table } from 'dexie';

// å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„
interface OutlineNodeDocument {
  id?: number; // IndexedDB è‡ªå¢ä¸»é”®ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
  documentId: string; // æ–‡æ¡£ IDï¼ˆä¸šåŠ¡ IDï¼‰
  data: Document; // å®Œæ•´çš„æ–‡æ¡£æ•°æ®
  createdAt: number;
  updatedAt: number;
}

interface ConfigDocument {
  key: string; // ä¸»é”®ï¼šé…ç½®åï¼ˆå¦‚ 'user-config'ï¼‰
  value: any;  // é…ç½®å€¼
  updatedAt: number;
}

class OutlineDatabase extends Dexie {
  documents!: Table<OutlineNodeDocument, number>;
  configs!: Table<ConfigDocument, string>; // æ³›å‹ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸»é”®ç±»å‹ä¸º string

  constructor() {
    super('OutlineEditorDB');
    this.version(1).stores({
      // documentId æ˜¯ç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢
      documents: '++id, documentId, createdAt, updatedAt',
      // key æ˜¯ä¸»é”®ï¼ˆstring ç±»å‹ï¼‰ï¼ŒupdatedAt æ˜¯ç´¢å¼•
      configs: 'key, updatedAt',
    });
  }
}

export const db = new OutlineDatabase();
```

### 2. CRUD æ“ä½œå°è£…

```typescript
// lib/db.ts (ç»§ç»­)
export const documentDb = {
  // ä¿å­˜æ–‡æ¡£
  async saveDocument(document: Document): Promise<void> {
    const now = Date.now();
    const existing = await db.documents
      .where('documentId')
      .equals(document.id)
      .first();

    if (existing) {
      await db.documents.update(existing.id!, {
        data: document,
        updatedAt: now,
      });
    } else {
      await db.documents.add({
        documentId: document.id,
        data: document,
        createdAt: now,
        updatedAt: now,
      });
    }
  },

  // åŠ è½½æ–‡æ¡£
  async loadDocument(documentId: string): Promise<Document | null> {
    const doc = await db.documents
      .where('documentId')
      .equals(documentId)
      .first();
    return doc?.data || null;
  },

  // è·å–æ‰€æœ‰æ–‡æ¡£åˆ—è¡¨
  async listDocuments(): Promise<
    Array<{ id: string; title: string; updatedAt: number }>
  > {
    const docs = await db.documents.toArray();
    return docs.map((doc) => ({
      id: doc.data.id,
      title: doc.data.title,
      updatedAt: doc.data.metadata.updatedAt,
    }));
  },

  // åˆ é™¤æ–‡æ¡£
  async deleteDocument(documentId: string): Promise<void> {
    await db.documents
      .where('documentId')
      .equals(documentId)
      .delete();
  },
};

export const configDb = {
  // ä¿å­˜é…ç½®
  async saveConfig(key: string, value: any): Promise<void> {
    const existing = await db.configs.where('key').equals(key).first();
    if (existing) {
      await db.configs.update(existing.id!, { value, updatedAt: Date.now() });
    } else {
      await db.configs.add({ key, value, updatedAt: Date.now() });
    }
  },

  // åŠ è½½é…ç½®
  async loadConfig<T>(key: string): Promise<T | null> {
    const config = await db.configs.where('key').equals(key).first();
    return config?.value || null;
  },

  // åˆ é™¤é…ç½®
  async deleteConfig(key: string): Promise<void> {
    await db.configs.where('key').equals(key).delete();
  },
};
```

### 3. è‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

**å…³é”®ä¼˜åŒ–ï¼š**
- é˜²æ­¢å¹¶å‘å†²çªï¼ˆæ£€æŸ¥ saving çŠ¶æ€ï¼‰
- é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜ï¼ˆbeforeunload äº‹ä»¶ï¼‰

```typescript
// lib/store.ts (æ‰©å±•ç°æœ‰çš„ EditorStore)
interface EditorStore {
  // ... ç°æœ‰å­—æ®µ

  // è‡ªåŠ¨ä¿å­˜æ§åˆ¶
  autoSaveEnabled: boolean;
  lastSavedAt: number | null;
  saveStatus: 'idle' | 'saving' | 'saved' | 'error';

  // Actions
  enableAutoSave: () => void;
  disableAutoSave: () => void;
  saveDocument: () => Promise<void>;
  forceSaveNow: () => Promise<void>; // ç”¨äºé¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜
}

export const useEditorStore = create<EditorStore>()(
  immer((set, get) => ({
    // ... ç°æœ‰å®ç°

    autoSaveEnabled: true,
    lastSavedAt: null,
    saveStatus: 'idle',

    enableAutoSave: () => set({ autoSaveEnabled: true }),
    disableAutoSave: () => set({ autoSaveEnabled: false }),

    saveDocument: async () => {
      const state = get();

      // 1. é˜²æ­¢å¹¶å‘ï¼šå¦‚æœæ­£åœ¨ä¿å­˜ï¼Œç›´æ¥è·³è¿‡
      if (state.saveStatus === 'saving') {
        console.log('Skip save: already saving');
        return;
      }

      // [ä¿®æ­£] æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼ˆä½¿ç”¨ rootId è€Œé documentï¼‰
      if (!state.rootId || Object.keys(state.nodes).length === 0) {
        console.warn('No data to save');
        return;
      }

      set({ saveStatus: 'saving' });

      try {
        // [ä¿®æ­£] ä»æ‰å¹³æ•°æ®æ„å»º Document å¯¹è±¡
        const documentToSave = get().buildDocumentTree();
        await documentDb.saveDocument(documentToSave);

        set({
          lastSavedAt: Date.now(),
          saveStatus: 'saved',
        });

        // 2ç§’åé‡ç½®çŠ¶æ€
        setTimeout(() => {
          if (get().saveStatus === 'saved') {
            set({ saveStatus: 'idle' });
          }
        }, 2000);
      } catch (error) {
        console.error('Save failed:', error);
        set({ saveStatus: 'error' });
      }
    },

    // å¼ºåˆ¶ä¿å­˜ï¼ˆç”¨äºé¡µé¢å…³é—­å‰ï¼‰
    forceSaveNow: async () => {
      await get().saveDocument();
    },
  }))
);

// è‡ªåŠ¨ä¿å­˜ hook
export function useAutoSave(interval: number = 3000) {
  const saveDocument = useEditorStore((state) => state.saveDocument);
  const forceSaveNow = useEditorStore((state) => state.forceSaveNow);
  const autoSaveEnabled = useEditorStore((state) => state.autoSaveEnabled);

  useEffect(() => {
    if (!autoSaveEnabled) return;

    // å®šæ—¶ä¿å­˜
    const timer = setInterval(() => {
      saveDocument();
    }, interval);

    // é¡µé¢å…³é—­/åˆ·æ–°å‰ä¿å­˜
    const handleBeforeUnload = () => {
      forceSaveNow();
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      clearInterval(timer);
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [saveDocument, forceSaveNow, autoSaveEnabled, interval]);
}
```

### 4. JSON å¯¼å…¥/å¯¼å‡ºï¼ˆå¸¦ Zod æ ¡éªŒï¼‰

**å®‰å…¨æ€§ä¼˜åŒ–ï¼š**
- ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶æ•°æ®æ ¡éªŒ
- è¯¦ç»†çš„é”™è¯¯æç¤º

```typescript
// utils/import-export.ts
import { Document } from '@/types';
import { z } from 'zod';

// å®šä¹‰æ–‡æ¡£çš„ Zod Schema
const DocumentSchema = z.object({
  id: z.string(),
  title: z.string(),
  root: z.any(), // å®é™…é¡¹ç›®ä¸­åº”è¯¥å®šä¹‰å®Œæ•´çš„ OutlineNode Schema
  metadata: z.object({
    createdAt: z.number(),
    updatedAt: z.number(),
    version: z.string(),
  }),
});

// å¯¼å‡ºä¸º JSON
export function exportToJSON(document: Document): string {
  return JSON.stringify(document, null, 2);
}

// è§¦å‘ä¸‹è½½
export function downloadJSON(document: Document, filename?: string): void {
  const json = exportToJSON(document);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `${document.title}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ä» JSON å¯¼å…¥ï¼ˆå¸¦ Zod æ ¡éªŒï¼‰
export function importFromJSON(jsonString: string): Document {
  try {
    const data = JSON.parse(jsonString);

    // ä½¿ç”¨ Zod å¼ºæ ¡éªŒ
    const result = DocumentSchema.safeParse(data);

    if (!result.success) {
      console.error('Validation error:', result.error);
      throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬è¿‡æ—§æˆ–æ–‡ä»¶å·²æŸå');
    }

    return result.data;
  } catch (error) {
    if (error instanceof SyntaxError) {
      throw new Error('JSON è§£æå¤±è´¥ï¼šè¯­æ³•é”™è¯¯');
    }
    throw error;
  }
}

// ä»æ–‡ä»¶å¯¼å…¥
export async function importFromFile(file: File): Promise<Document> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const json = e.target?.result as string;
        const document = importFromJSON(json);
        resolve(document);
      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = () => {
      reject(new Error('Failed to read file'));
    };

    reader.readAsText(file);
  });
}
```

**æ€§èƒ½è¯´æ˜ï¼š**
- MVP é˜¶æ®µä½¿ç”¨å…¨é‡ä¿å­˜ï¼ˆæ¯æ¬¡ä¿å­˜æ•´ä¸ª Documentï¼‰
- é€‚åˆå‡ ç™¾ä¸ªèŠ‚ç‚¹çš„æ–‡æ¡£
- å¦‚æœèŠ‚ç‚¹æ•°è¶…è¿‡ 1000ï¼Œæœªæ¥å¯è€ƒè™‘å¢é‡æ›´æ–°ä¼˜åŒ–

---

## å·¥å…·æ ä¸è®¾ç½®ç•Œé¢è®¾è®¡

### 1. å·¥å…·æ ç»„ä»¶

**çŠ¶æ€ç®¡ç†ä¼˜åŒ–ï¼š**
- Modal çŠ¶æ€ï¼ˆshowAIModalã€showSettingsï¼‰æ”¾åœ¨ EditorStore ä¸­
- ä¾¿äºå…¶ä»–ç»„ä»¶æ§åˆ¶å¼¹çª—ï¼ˆå¦‚ AI é‡ç»„å®Œæˆåè‡ªåŠ¨å…³é—­ï¼‰

```typescript
// components/Toolbar.tsx
'use client';

import { useState } from 'react';
import { useEditorStore } from '@/lib/store';
import { useDocumentIO } from '@/hooks/useDocumentIO';
import { SaveStatus } from './SaveStatus';
import { ToolbarButton } from './ToolbarButton';

export function Toolbar() {
  const { handleImport, handleExport } = useDocumentIO();
  const showAIModal = useEditorStore((s) => s.showAIModal);
  const showSettings = useEditorStore((s) => s.showSettings);
  const setShowAIModal = useEditorStore((s) => s.setShowAIModal);
  const setShowSettings = useEditorStore((s) => s.setShowSettings);

  return (
    <div className="flex items-center justify-between border-b px-4 py-2">
      <div className="flex items-center gap-2">
        {/* å·¦ä¾§ï¼šæ–‡ä»¶æ“ä½œ */}
        <ToolbarButton
          icon="ğŸ“¥"
          label="å¯¼å…¥"
          onClick={() => document.getElementById('import-input')?.click()}
        />
        <input
          id="import-input"
          type="file"
          accept=".json"
          className="hidden"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) handleImport(file);
          }}
        />

        <ToolbarButton
          icon="ğŸ“¤"
          label="å¯¼å‡º"
          onClick={handleExport}
        />

        <div className="mx-2 h-6 w-px bg-gray-300" />

        {/* æ ¸å¿ƒåŠŸèƒ½ï¼šAI æ•´ç† */}
        <ToolbarButton
          icon="âœ¨"
          label="AI æ•´ç†"
          onClick={() => setShowAIModal(true)}
          primary
        />
      </div>

      <div className="flex items-center gap-4">
        {/* ä¿å­˜çŠ¶æ€æŒ‡ç¤º */}
        <SaveStatus />

        {/* å³ä¾§ï¼šè®¾ç½® */}
        <ToolbarButton
          icon="âš™ï¸"
          label="è®¾ç½®"
          onClick={() => setShowSettings(true)}
        />
      </div>

      {/* Modals */}
      {showAIModal && <AIReorganizeModal onClose={() => setShowAIModal(false)} />}
      {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}
    </div>
  );
}
```

### 2. æ–‡æ¡£å¯¼å…¥/å¯¼å‡º Hook

**èŒè´£åˆ†ç¦»ï¼š**
- Toolbar åªè´Ÿè´£ UI
- ä¸šåŠ¡é€»è¾‘æŠ½ç¦»åˆ° useDocumentIO hook

```typescript
// hooks/useDocumentIO.ts
import { useCallback } from 'react';
import { useEditorStore } from '@/lib/store';
import { importFromFile, downloadJSON } from '@/utils/import-export';

export function useDocumentIO() {
  const loadDocument = useEditorStore((s) => s.loadDocument);
  const document = useEditorStore((s) => s.document);

  const handleImport = useCallback(
    async (file: File) => {
      try {
        const doc = await importFromFile(file);
        loadDocument(doc);
        toast.success('å¯¼å…¥æˆåŠŸ');
      } catch (e) {
        toast.error('å¯¼å…¥å¤±è´¥ï¼š' + (e as Error).message);
      }
    },
    [loadDocument]
  );

  const handleExport = useCallback(() => {
    if (!document) {
      toast.error('æ²¡æœ‰å¯å¯¼å‡ºçš„æ–‡æ¡£');
      return;
    }
    downloadJSON(document);
    toast.success('å¯¼å‡ºæˆåŠŸ');
  }, [document]);

  return { handleImport, handleExport };
}
```

### 3. è®¾ç½®ç•Œé¢ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

**å…³é”®ä¼˜åŒ–ï¼š**
- hasChanges è‡ªåŠ¨æ£€æµ‹ï¼ˆå¯¹æ¯” initialConfigï¼‰
- API Key æ˜¾ç¤º/éšè—åˆ‡æ¢

```typescript
// components/SettingsModal.tsx
'use client';

import { useState, useEffect } from 'react';
import { useEditorStore } from '@/lib/store';
import { configDb } from '@/lib/db';
import { UserConfig } from '@/types';

export function SettingsModal({ onClose }: { onClose: () => void }) {
  const [config, setConfig] = useState<UserConfig>({
    aiProvider: 'openai',
    apiKeys: {},
    imageUpload: {
      provider: 'imgur',
      apiKey: '',
      customUrl: '',
    },
  });
  const [initialConfig, setInitialConfig] = useState<UserConfig>(config);
  const [showKeys, setShowKeys] = useState(false);

  // åŠ è½½é…ç½®
  useEffect(() => {
    configDb.loadConfig<UserConfig>('user-config').then((savedConfig) => {
      if (savedConfig) {
        setConfig(savedConfig);
        setInitialConfig(savedConfig);
      }
    });
  }, []);

  // è‡ªåŠ¨æ£€æµ‹å˜æ›´
  const hasChanges = JSON.stringify(config) !== JSON.stringify(initialConfig);

  const handleSave = async () => {
    await configDb.saveConfig('user-config', config);
    onClose();
    toast.success('è®¾ç½®å·²ä¿å­˜');
  };

  return (
    <Modal onClose={onClose}>
      <div className="space-y-6 p-6">
        <h2 className="text-xl font-semibold">è®¾ç½®</h2>

        {/* AI é…ç½® */}
        <section>
          <h3 className="text-lg font-medium mb-3">AI æœåŠ¡</h3>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium mb-1">
                AI æä¾›å•†
              </label>
              <select
                value={config.aiProvider}
                onChange={(e) =>
                  setConfig({ ...config, aiProvider: e.target.value as any })
                }
                className="w-full border rounded px-3 py-2"
              >
                <option value="claude">Claude (Anthropic)</option>
                <option value="openai">OpenAI (GPT)</option>
                <option value="gemini">Google Gemini</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                API Key
              </label>
              <div className="flex gap-2">
                <input
                  type={showKeys ? 'text' : 'password'}
                  value={config.apiKeys[config.aiProvider] || ''}
                  onChange={(e) =>
                    setConfig({
                      ...config,
                      apiKeys: {
                        ...config.apiKeys,
                        [config.aiProvider]: e.target.value,
                      },
                    })
                  }
                  placeholder="è¾“å…¥ä½ çš„ API Key"
                  className="flex-1 border rounded px-3 py-2"
                />
                <button
                  type="button"
                  onClick={() => setShowKeys(!showKeys)}
                  className="px-3 py-2 border rounded hover:bg-gray-100"
                >
                  {showKeys ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                </button>
              </div>
            </div>
          </div>
        </section>

        <div className="border-t" />

        {/* å›¾åºŠé…ç½® */}
        <section>
          <h3 className="text-lg font-medium mb-3">å›¾åºŠä¸Šä¼ </h3>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium mb-1">
                å›¾åºŠæœåŠ¡
              </label>
              <select
                value={config.imageUpload.provider}
                onChange={(e) =>
                  setConfig({
                    ...config,
                    imageUpload: {
                      ...config.imageUpload,
                      provider: e.target.value as any,
                    },
                  })
                }
                className="w-full border rounded px-3 py-2"
              >
                <option value="imgur">Imgur</option>
                <option value="smms">SM.MS</option>
                <option value="custom">è‡ªå®šä¹‰</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                API Key
              </label>
              <div className="flex gap-2">
                <input
                  type={showKeys ? 'text' : 'password'}
                  value={config.imageUpload.apiKey || ''}
                  onChange={(e) =>
                    setConfig({
                      ...config,
                      imageUpload: {
                        ...config.imageUpload,
                        apiKey: e.target.value,
                      },
                    })
                  }
                  placeholder="è¾“å…¥å›¾åºŠ API Key"
                  className="flex-1 border rounded px-3 py-2"
                />
                <button
                  type="button"
                  onClick={() => setShowKeys(!showKeys)}
                  className="px-3 py-2 border rounded hover:bg-gray-100"
                >
                  {showKeys ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                </button>
              </div>
            </div>

            {config.imageUpload.provider === 'custom' && (
              <div>
                <label className="block text-sm font-medium mb-1">
                  è‡ªå®šä¹‰ API åœ°å€
                </label>
                <input
                  type="url"
                  value={config.imageUpload.customUrl || ''}
                  onChange={(e) => {
                    let url = e.target.value;
                    // [ä¼˜åŒ–] è‡ªåŠ¨è¡¥å…¨ https://ï¼Œé˜²æ­¢ Mixed Content è­¦å‘Š
                    if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                      url = 'https://' + url;
                    }
                    setConfig({
                      ...config,
                      imageUpload: {
                        ...config.imageUpload,
                        customUrl: url,
                      },
                    });
                  }}
                  placeholder="https://your-image-host.com/api/upload"
                  className="w-full border rounded px-3 py-2"
                />
                <p className="text-xs text-gray-500 mt-1">
                  æç¤ºï¼šURL ä¼šè‡ªåŠ¨è¡¥å…¨ https:// å‰ç¼€
                </p>
              </div>
            )}
          </div>
        </section>

        <div className="flex justify-end gap-3 pt-4">
          <button onClick={onClose} className="px-4 py-2 border rounded">
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            disabled={!hasChanges}
            className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </Modal>
  );
}
```

---

## æ–‡æ¡£åˆ—è¡¨ç®¡ç†ï¼ˆMVP é˜¶æ®µï¼‰

### è®¾è®¡è¯´æ˜

**MVP é˜¶æ®µï¼šå¹³é“ºæ‰€æœ‰æ–‡æ¡£**

- æ‰€æœ‰æ–‡æ¡£å±•ç¤ºåœ¨ä¾§è¾¹æ åˆ—è¡¨ä¸­ï¼ˆç±»ä¼¼å¹•å¸ƒçš„"æˆ‘çš„æ¡Œé¢"ï¼‰
- æ”¯æŒé€šè¿‡æ ‡é¢˜æˆ–åˆ›å»ºæ—¶é—´æ’åº
- ç‚¹å‡»æ–‡æ¡£å¡ç‰‡åˆ‡æ¢åˆ°å¯¹åº”æ–‡æ¡£
- æš‚ä¸æ”¯æŒæ–‡ä»¶å¤¹åµŒå¥—åŠŸèƒ½ï¼ˆåç»­è¿­ä»£ï¼‰

### æ•°æ®æµè®¾è®¡

```
ç”¨æˆ·æ‰“å¼€åº”ç”¨ â†’ å‰ç«¯è§¦å‘ fetchDocuments â†’ è°ƒç”¨åç«¯ /api/documents
â†’ åç«¯ä» Dexie è·å–æ•°æ® â†’ å‰ç«¯æ›´æ–° store â†’ ç»„ä»¶æ¸²æŸ“æ–‡æ¡£åˆ—è¡¨
```

### åç«¯å®ç°

```typescript
// app/api/documents/route.ts
import { NextResponse } from 'next/server';
import { documentDb } from '@/lib/db';

export async function GET() {
  try {
    const documents = await documentDb.listDocuments();
    return NextResponse.json({ success: true, data: documents });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to fetch documents' },
      { status: 500 }
    );
  }
}
```

### å‰ç«¯ Store æ‰©å±•

```typescript
// lib/store.ts (æ·»åŠ åˆ° EditorStore)
interface EditorStore {
  // æ–‡æ¡£åˆ—è¡¨
  documents: Array<{ id: string; title: string; updatedAt: number }>;
  isLoadingDocuments: boolean;
  fetchDocuments: () => Promise<void>;
}

export const useEditorStore = create<EditorStore>()(
  immer((set, get) => ({
    // ... ç°æœ‰å®ç°

    documents: [],
    isLoadingDocuments: false,

    fetchDocuments: async () => {
      set({ isLoadingDocuments: true });
      try {
        const res = await fetch('/api/documents');
        const data = await res.json();
        if (data.success) {
          set({ documents: data.data });
        }
      } catch (error) {
        console.error('Failed to fetch documents:', error);
      } finally {
        set({ isLoadingDocuments: false });
      }
    },
  }))
);
```

### å‰ç«¯ç»„ä»¶ä½¿ç”¨

```typescript
// components/DocumentList.tsx
'use client';

import { useEffect } from 'react';
import { useEditorStore } from '@/lib/store';

export function DocumentList() {
  const documents = useEditorStore((s) => s.documents);
  const isLoadingDocuments = useEditorStore((s) => s.isLoadingDocuments);
  const fetchDocuments = useEditorStore((s) => s.fetchDocuments);

  useEffect(() => {
    fetchDocuments();
  }, [fetchDocuments]);

  if (isLoadingDocuments) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  return (
    <div className="space-y-2">
      {documents.map((doc) => (
        <div
          key={doc.id}
          className="p-3 border rounded hover:bg-gray-50 cursor-pointer"
          onClick={() => {/* åˆ‡æ¢åˆ°è¯¥æ–‡æ¡£ */}}
        >
          <div className="font-medium">{doc.title}</div>
          <div className="text-sm text-gray-500">
            {new Date(doc.updatedAt).toLocaleString()}
          </div>
        </div>
      ))}
    </div>
  );
}
```

### åç»­è¿­ä»£æ–¹å‘

**V2+ å¯æ‰©å±•æ–‡ä»¶å¤¹åŠŸèƒ½ï¼š**
- æ–°å¢ Folder å®ä½“ï¼ˆidã€nameã€childrenï¼‰
- æ”¯æŒæ–‡ä»¶å¤¹å±•å¼€/æŠ˜å  UI
- æ”¯æŒæ‹–æ‹½æ’åºå’Œå³é”®èœå•
- æ•°æ®æ¨¡å‹æ·»åŠ  folderId å­—æ®µ

å½“å‰æ¶æ„å·²é¢„ç•™æ‰©å±•æ€§ï¼Œæ— éœ€å¤§è§„æ¨¡é‡æ„ã€‚

---

## æ’¤é”€/é‡åšä¸å¿«æ·é”®è®¾è®¡

### 1. å†å²æ ˆç®¡ç†

**æ ¸å¿ƒè®¾è®¡ï¼š**
- ç®€å•çš„æ—¶é—´æˆ³å¿«ç…§æ¨¡å¼
- é™åˆ¶å†å²æ ˆå¤§å°ï¼ˆé»˜è®¤ 30 æ­¥ï¼‰
- æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆå¦‚ AI é‡ç»„ï¼‰

```typescript
// lib/store.ts (æ‰©å±• EditorStore)
interface EditorStore {
  // ... ç°æœ‰å­—æ®µ

  // å†å²æ ˆ
  history: {
    past: Document[];
    present: Document | null;
    future: Document[];
  };

  // Actions
  undo: () => void;
  redo: () => void;
  pushHistory: (document: Document) => void;
  clearHistory: () => void;

  // è¾…åŠ©
  canUndo: boolean;
  canRedo: boolean;
}

export const useEditorStore = create<EditorStore>()(
  immer((set, get) => ({
    // ... ç°æœ‰å®ç°

    history: {
      past: [],
      present: null,
      future: [],
    },

    canUndo: false,
    canRedo: false,

    pushHistory: (document) => {
      set((state) => {
        // é™åˆ¶å†å²æ ˆå¤§å°
        const MAX_HISTORY = 30;

        // æ·±æ‹·è´å½“å‰æ–‡æ¡£ä½œä¸ºå¿«ç…§
        const snapshot = JSON.parse(JSON.stringify(document));

        // å¦‚æœæœ‰ presentï¼Œç§»å…¥ past
        if (state.history.present) {
          state.history.past.push(state.history.present);
        }

        // è®¾ç½®æ–°çš„ present
        state.history.present = snapshot;

        // æ¸…ç©º futureï¼ˆæ–°çš„æ“ä½œåˆ†æ”¯ï¼‰
        state.history.future = [];

        // é™åˆ¶ past å¤§å°
        if (state.history.past.length > MAX_HISTORY) {
          state.history.past.shift();
        }

        // æ›´æ–° canUndo/canRedo
        state.canUndo = state.history.past.length > 0;
        state.canRedo = false;
      });
    },

    undo: () => {
      set((state) => {
        const { past, present, future } = state.history;

        if (past.length === 0 || !present) return;

        // present ç§»å…¥ future
        const previous = past[past.length - 1];
        const newPast = past.slice(0, past.length - 1);

        state.history = {
          past: newPast,
          present: previous,
          future: [present, ...future],
        };

        state.canUndo = newPast.length > 0;
        state.canRedo = true;

        // åŒæ­¥åˆ° document
        state.document = previous;
      });
    },

    redo: () => {
      set((state) => {
        const { past, present, future } = state.history;

        if (future.length === 0) return;

        // future çš„ç¬¬ä¸€ä¸ªç§»å…¥ present
        const next = future[0];
        const newFuture = future.slice(1);

        state.history = {
          past: [...past, present!],
          present: next,
          future: newFuture,
        };

        state.canUndo = true;
        state.canRedo = newFuture.length > 0;

        // åŒæ­¥åˆ° document
        state.document = next;
      });
    },

    clearHistory: () => {
      set((state) => {
        state.history = {
          past: [],
          present: state.document,
          future: [],
        };
        state.canUndo = false;
        state.canRedo = false;
      });
    },
  }))
);
```

### 2. è‡ªåŠ¨è®°å½•å†å²

**è§¦å‘æ—¶æœºï¼š**
- ç¼–è¾‘èŠ‚ç‚¹å†…å®¹åï¼ˆé˜²æŠ–ï¼‰
- åº”ç”¨ AI é‡ç»„è®¡åˆ’å
- å¯¼å…¥æ–‡æ¡£å
- æ‰‹åŠ¨ä¿å­˜åï¼ˆå¯é€‰ï¼‰

```typescript
// hooks/useAutoHistory.ts
import { useEffect } from 'react';
import { useEditorStore } from '@/lib/store';
import { debounce } from 'lodash';

export function useAutoHistory() {
  const document = useEditorStore((s) => s.document);
  const pushHistory = useEditorStore((s) => s.pushHistory);

  // é˜²æŠ–ï¼šç”¨æˆ·åœæ­¢è¾“å…¥ 500ms åæ‰è®°å½•å†å²
  const debouncedPushHistory = debounce(
    (doc) => {
      if (doc) pushHistory(doc);
    },
    500,
    { trailing: true }
  );

  useEffect(() => {
    if (document) {
      debouncedPushHistory(document);
    }
  }, [document, debouncedPushHistory]);
}
```

### 3. å¿«æ·é”®æ”¯æŒ

**æ ¸å¿ƒå¿«æ·é”®ï¼š**
- `Ctrl/Cmd + Z`: æ’¤é”€
- `Ctrl/Cmd + Shift + Z` æˆ– `Ctrl/Cmd + Y`: é‡åš
- `Ctrl/Cmd + S`: æ‰‹åŠ¨ä¿å­˜
- `Ctrl/Cmd + N`: æ–°å»ºæ–‡æ¡£
- `Alt + Enter`: æ’å…¥å›¾ç‰‡

```typescript
// hooks/useKeyboardShortcuts.ts
import { useEffect } from 'react';
import { useEditorStore } from '@/lib/store';

export function useKeyboardShortcuts() {
  const undo = useEditorStore((s) => s.undo);
  const redo = useEditorStore((s) => s.redo);
  const saveDocument = useEditorStore((s) => s.saveDocument);
  const canUndo = useEditorStore((s) => s.canUndo);
  const canRedo = useEditorStore((s) => s.canRedo);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;

      if (!cmdOrCtrl) return;

      switch (e.key.toLowerCase()) {
        case 'z':
          e.preventDefault();
          if (e.shiftKey) {
            // Ctrl/Cmd + Shift + Z: é‡åš
            if (canRedo) redo();
          } else {
            // Ctrl/Cmd + Z: æ’¤é”€
            if (canUndo) undo();
          }
          break;

        case 'y':
          // Ctrl/Cmd + Y: é‡åšï¼ˆWindows é£æ ¼ï¼‰
          e.preventDefault();
          if (canRedo) redo();
          break;

        case 's':
          // Ctrl/Cmd + S: ä¿å­˜
          e.preventDefault();
          saveDocument();
          break;

        case 'n':
          // Ctrl/Cmd + N: æ–°å»ºæ–‡æ¡£
          e.preventDefault();
          // TODO: å®ç°æ–°å»ºæ–‡æ¡£é€»è¾‘
          break;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [undo, redo, saveDocument, canUndo, canRedo]);
}
```

### 4. å·¥å…·æ ä¸­çš„æ’¤é”€/é‡åšæŒ‰é’®

```typescript
// components/Toolbar.tsx (æ·»åŠ )
import { useEditorStore } from '@/lib/store';

export function Toolbar() {
  const canUndo = useEditorStore((s) => s.canUndo);
  const canRedo = useEditorStore((s) => s.canRedo);
  const undo = useEditorStore((s) => s.undo);
  const redo = useEditorStore((s) => s.redo);

  return (
    <div className="flex items-center justify-between border-b px-4 py-2">
      {/* ... ç°æœ‰å†…å®¹ */}

      <div className="flex items-center gap-2">
        {/* æ’¤é”€/é‡åšæŒ‰é’® */}
        <ToolbarButton
          icon="â†©ï¸"
          label="æ’¤é”€"
          onClick={undo}
          disabled={!canUndo}
          shortcut="âŒ˜Z"
        />

        <ToolbarButton
          icon="â†ªï¸"
          label="é‡åš"
          onClick={redo}
          disabled={!canRedo}
          shortcut="âŒ˜â‡§Z"
        />

        {/* ... å…¶ä»–æŒ‰é’® */}
      </div>
    </div>
  );
}
```

---

## å¾…å®Œæˆçš„è®¾è®¡

### 5. æ¬¡è¦åŠŸèƒ½ï¼ˆåç»­è¿­ä»£ï¼‰
- [ ] æœç´¢åŠŸèƒ½ï¼ˆä½ä¼˜å…ˆçº§ï¼ŒèŠ‚ç‚¹ > 100 æ—¶å†è€ƒè™‘ï¼‰
- [ ] æ›´å¤šå¿«æ·é”®ï¼ˆæ‹–æ‹½ã€æ ¼å¼åŒ–ç­‰ï¼‰

---

## å…³é”®æŠ€æœ¯å†³ç­–

### âœ… å·²ç¡®å®šçš„ä¼˜åŒ–

1. **æ•°æ®æ¨¡å‹ä¼˜åŒ–**
   - æ·»åŠ  `parentId` å­—æ®µæå‡æŸ¥æ‰¾æ€§èƒ½
   - `ReorganizeChange` ä½¿ç”¨ ID è·¯å¾„è€Œéå†…å®¹è·¯å¾„
   - `ImageAttachment` å¢åŠ  `alt` å’Œ `caption` å­—æ®µ

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰å¹³åŒ– Store å­˜å‚¨ï¼ˆ`Record<string, OutlineNode>`ï¼‰
   - React.memo + Zustand Selector é¿å…å…¨é‡é‡æ¸²æŸ“
   - ä½¿ç”¨ `<input>` ä»£æ›¿ `contenteditable`

3. **AI åŠŸèƒ½ä¼˜åŒ–**
   - AI åªè¿”å›ç»“æ„ï¼Œä¸è´Ÿè´£è®¡ç®—å·®å¼‚
   - ä½¿ç”¨ `generateObject` + `Zod` ä¿è¯ç±»å‹å®‰å…¨
   - å‰ç«¯ç®—æ³•è®¡ç®— Diff

4. **æ¶æ„ä¼˜åŒ–**
   - Next.js å…¨æ ˆä¸€ä½“åŒ–ï¼ˆå‰ç«¯ + API Routes + Server Actionsï¼‰
   - æŒ‰åŠŸèƒ½åˆ†ç»„çš„ç»„ä»¶ç»“æ„

5. **æ•°æ®æŒä¹…åŒ–ä¼˜åŒ–**
   - ä¿®æ­£ Dexie è¡¨ç»“æ„å®šä¹‰ï¼ˆconfigs è¡¨ä¸»é”®ä¸º stringï¼‰
   - é˜²æ­¢è‡ªåŠ¨ä¿å­˜å¹¶å‘å†²çª
   - é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜ï¼ˆbeforeunloadï¼‰
   - ä½¿ç”¨ Zod æ ¡éªŒå¯¼å…¥çš„ JSON

6. **å›¾åºŠä¸Šä¼ ä¼˜åŒ–**
   - é€‚é…ä¸åŒå›¾åºŠçš„è¡¨å•å­—æ®µå’Œå“åº”ç»“æ„
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ ¼å¼
   - å®Œæ•´çš„æ–‡ä»¶æ ¡éªŒï¼ˆç±»å‹ã€å¤§å°ï¼‰

7. **UI/UX ä¼˜åŒ–**
   - Modal çŠ¶æ€é›†ä¸­åœ¨ EditorStore ç®¡ç†
   - å¯¼å…¥/å¯¼å‡ºé€»è¾‘æŠ½ç¦»ä¸º useDocumentIO hook
   - è®¾ç½®ç•Œé¢è‡ªåŠ¨æ£€æµ‹å˜æ›´ï¼ˆhasChangesï¼‰
   - API Key è¾“å…¥æ”¯æŒæ˜¾ç¤º/éšè—åˆ‡æ¢

8. **æ ¸å¿ƒä½“éªŒä¼˜åŒ–**
   - æ’¤é”€/é‡åšåŠŸèƒ½ï¼ˆå†å²æ ˆ + å¿«æ·é”®ï¼‰
   - è‡ªåŠ¨è®°å½•å†å²ï¼ˆé˜²æŠ–ï¼‰
   - å¸¸ç”¨å¿«æ·é”®æ”¯æŒ

---

## å¼€å‘ä¼˜å…ˆçº§

### Phase 1: MVP æ ¸å¿ƒ
1. åŸºç¡€æ•°æ®ç»“æ„ + Zustand Store
2. å¤§çº²ç¼–è¾‘å™¨ï¼ˆå¢åˆ æ”¹æŸ¥ã€æŠ˜å /å±•å¼€ï¼‰
3. IndexedDB æœ¬åœ°å­˜å‚¨
4. JSON å¯¼å…¥/å¯¼å‡º
5. å·¥å…·æ  + è®¾ç½®ç•Œé¢
6. **æ’¤é”€/é‡åšï¼ˆæ ¸å¿ƒä½“éªŒï¼‰**

### Phase 2: AI åŠŸèƒ½
1. AI Schema å®šä¹‰
2. Server Action å®ç°
3. å‰ç«¯ Diff ç®—æ³•
4. é‡ç»„é¢„è§ˆ UI

### Phase 3: å›¾ç‰‡åŠŸèƒ½
1. å›¾åºŠé…ç½®ç•Œé¢
2. å›¾ç‰‡ä¸Šä¼ ä»£ç†
3. å›¾ç‰‡æ’å…¥å’Œæ˜¾ç¤º

### Phase 4: ä¼˜åŒ–è¿­ä»£
1. å®Œæ•´å¿«æ·é”®æ”¯æŒ
2. æ€§èƒ½ä¼˜åŒ–
3. æœç´¢åŠŸèƒ½ï¼ˆæ ¹æ®ç”¨æˆ·åé¦ˆå†³å®šï¼‰

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-02-08*

